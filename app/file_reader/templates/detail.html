{% extends "base.html" %}
{% load static %}

{% block content %}
    <h1>{{ document.file.name }}</h1>

    <!-- Controls ABOVE -->
    <div style="margin-bottom: 15px;">
        <button onclick="playAll()">▶ Play All</button>
        <button onclick="pauseAudio()">⏸ Pause</button>
        <button onclick="stopAudio()">⏹ Stop</button>
        <button onclick="restartAudio()">⏮ Restart</button>
    </div>

    <!-- Lines -->
    <ol id="lines">
        {% for line in lines %}
            <li id="line-{{ forloop.counter0 }}">{{ line.text }}</li>
        {% endfor %}
    </ol>

    <!-- Hidden single audio player -->
    <audio id="audioPlayer" style="display:none;"></audio>

    <script>
        const audioPlayer = document.getElementById("audioPlayer");
        const lines = document.querySelectorAll("#lines li");

        const audioFiles = [
            {% for line in lines %}
                "{{ line.audio_file.url }}",
            {% endfor %}
        ];

        let currentIndex = 0;

        function highlightLine(index) {
            lines.forEach((line, i) => {
                line.style.color = (i === index) ? "blue" : "black";
            });
        }

        function playAll() {
            if (currentIndex >= audioFiles.length) {
                currentIndex = 0; // restart after finishing
            }
            highlightLine(currentIndex);
            audioPlayer.src = audioFiles[currentIndex];
            audioPlayer.play();
        }

        audioPlayer.addEventListener("ended", () => {
            currentIndex++;
            if (currentIndex < audioFiles.length) {
                playAll();  // play next line
            } else {
                highlightLine(-1); // clear highlight when done
            }
        });

        function pauseAudio() {
            audioPlayer.pause();
        }

        function stopAudio() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            highlightLine(-1); // remove highlight
        }

        function restartAudio() {
            currentIndex = 0;
            playAll();
        }
    </script>
{% endblock %}

